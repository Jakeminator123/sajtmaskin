BUGGRAPPORT: Installation och V0-integration
==============================================
Genererad: 2026-02-01
Projekt: sajtmaskin
Fokus: Installation, första prompt, follow-up prompts, V0-agent begränsningar

═══════════════════════════════════════════════════════════════════════════
ÖVERSIKT
═══════════════════════════════════════════════════════════════════════════

Detta dokument identifierar buggar relaterade till installationsflödet när
användare besöker sajten för att bygga sin nya hemsida. Varje bugg bedöms
med:
- Sannolikhet att det är en bugg (1-100%)
- Påverkan (Låg/Medel/Hög/Kritisk)

═══════════════════════════════════════════════════════════════════════════
BUGG #1: Initial prompt skickas inte automatiskt till V0
═══════════════════════════════════════════════════════════════════════════

BESKRIVNING:
När en användare besöker /builder med en prompt (via ?prompt= eller ?promptId=),
så fylls prompten i i input-fältet, men den skickas INTE automatiskt till V0.
Användaren måste manuellt klicka på "Skicka" för att starta genereringen.

PLATS:
- src/app/builder/page.tsx:787 - initialPrompt skickas till ChatInterface
- src/components/builder/ChatInterface.tsx:155-163 - initialPrompt fylls i i input
- src/components/builder/ChatInterface.tsx:358-366 - handleSubmit kräver manuell aktion

FÖRVÄNTAT BETEENDE:
När resolvedPrompt finns och chatId saknas, ska en ny chat automatiskt skapas
och prompten skickas till V0 utan användarinteraktion.

FAKTISKT BETEENDE:
Prompten fylls i i input-fältet, men användaren måste manuellt klicka på
"Skicka" eller trycka Enter.

SANNOLIKHET ATT DET ÄR EN BUGG: 95%
PÅVERKAN: Hög
PRIORITET: Hög

KOD-REFERENS:
```typescript
// src/app/builder/page.tsx:787
const initialPrompt = templateId ? null : resolvedPrompt?.trim() || null;

// src/components/builder/ChatInterface.tsx:155-163
useEffect(() => {
  if (chatId) return;
  if (!initialPrompt) return;
  if (prefilledPromptRef.current === initialPrompt) return;
  if (input.trim()) return;
  setInput(initialPrompt);  // <-- Fyller bara i, skapar inte chat
  setManualEnhanceUsed(false);
  prefilledPromptRef.current = initialPrompt;
}, [chatId, initialPrompt, input]);
```

FÖRSLAGEN FIX:
Lägg till automatisk skapning när initialPrompt finns och chatId saknas:
```typescript
useEffect(() => {
  if (chatId) return;
  if (!initialPrompt) return;
  if (prefilledPromptRef.current === initialPrompt) return;

  setInput(initialPrompt);
  prefilledPromptRef.current = initialPrompt;

  // Automatiskt skapa chat om onCreateChat finns
  if (onCreateChat && initialPrompt.trim()) {
    onCreateChat(initialPrompt).catch(console.error);
  }
}, [chatId, initialPrompt, onCreateChat]);
```

═══════════════════════════════════════════════════════════════════════════
BUGG #2: promptId kan misslyckas tyst utan feedback
═══════════════════════════════════════════════════════════════════════════

BESKRIVNING:
Om en användare besöker /builder?promptId=xxx men prompten inte finns i
sessionStorage eller localStorage, så händer ingenting. Ingen felmeddelande
visas och användaren vet inte varför inget händer.

PLATS:
- src/app/builder/page.tsx:153-160

FÖRVÄNTAT BETEENDE:
Om promptId finns i URL men prompten inte hittas i storage, ska användaren
informeras (toast/alert) eller så ska promptId tas bort från URL.

FAKTISKT BETEENDE:
Ingenting händer. resolvedPrompt förblir null och användaren ser tom input.

SANNOLIKHET ATT DET ÄR EN BUGG: 90%
PÅVERKAN: Medel
PRIORITET: Medel

KOD-REFERENS:
```typescript
// src/app/builder/page.tsx:153-160
useEffect(() => {
  if (!promptId || typeof window === "undefined") return;
  const storageKey = `sajtmaskin_freeform_prompt:${promptId}`;
  const storedPrompt = sessionStorage.getItem(storageKey) || localStorage.getItem(storageKey);
  if (storedPrompt) {
    setResolvedPrompt(storedPrompt);
  }
  // <-- Ingen hantering om storedPrompt är null
}, [promptId]);
```

FÖRSLAGEN FIX:
Lägg till felhantering:
```typescript
useEffect(() => {
  if (!promptId || typeof window === "undefined") return;
  const storageKey = `sajtmaskin_freeform_prompt:${promptId}`;
  const storedPrompt = sessionStorage.getItem(storageKey) || localStorage.getItem(storageKey);
  if (storedPrompt) {
    setResolvedPrompt(storedPrompt);
  } else {
    // Ta bort promptId från URL och informera användaren
    toast.error("Prompt hittades inte. Den kan ha gått ut eller tagits bort.");
    router.replace("/builder");
  }
}, [promptId, router]);
```

═══════════════════════════════════════════════════════════════════════════
BUGG #3: V0-agenten saknar garanti för Shadcn-installation
═══════════════════════════════════════════════════════════════════════════

BESKRIVNING:
V0 får instruktioner att använda shadcn/ui komponenter (via promptAssist och
buildV0PromptFromBrief), men det finns ingen verifiering eller post-processing
som säkerställer att shadcn faktiskt är korrekt installerat i genererad kod.
V0 kan generera kod som refererar till shadcn-komponenter utan att installera
dem eller konfigurera dem korrekt.

PLATS:
- src/lib/builder/promptAssist.ts:116 - "Use shadcn/ui components where appropriate"
- src/lib/builder/defaults.ts:144 - Instruktioner om shadcn/ui
- src/app/api/v0/deployments/route.ts:327 - applyPreDeployFixes (fixar inte shadcn)

FÖRVÄNTAT BETEENDE:
När V0 genererar kod som använder shadcn/ui, ska shadcn vara korrekt installerat
med alla nödvändiga dependencies, components.json, och komponentfiler.

FAKTISKT BETEENDE:
V0 kan generera kod med shadcn-referenser utan att faktiskt installera shadcn.
Detta kan leda till runtime-fel när koden deployas.

SANNOLIKHET ATT DET ÄR EN BUGG: 85%
PÅVERKAN: Hög
PRIORITET: Hög

KOD-REFERENS:
```typescript
// src/lib/builder/promptAssist.ts:116
"Use shadcn/ui components where appropriate (buttons, inputs, cards, dialogs)."

// src/app/api/v0/deployments/route.ts:327
const { files: fixedFiles, fixesApplied, warnings } = applyPreDeployFixes(textFiles);
// applyPreDeployFixes fixar INTE shadcn-installation
```

FÖRSLAGEN FIX:
1. Lägg till post-processing som verifierar shadcn-installation
2. Om shadcn-referenser finns men installation saknas, lägg till:
   - package.json dependencies (@radix-ui/*, class-variance-authority, etc.)
   - components.json konfiguration
   - Grundläggande komponentfiler (button, input, etc.)
3. Eller förbättra V0-prompten med mer specifika instruktioner om installation

═══════════════════════════════════════════════════════════════════════════
BUGG #4: Pre-deploy fixes är begränsade och missar många problem
═══════════════════════════════════════════════════════════════════════════

BESKRIVNING:
applyPreDeployFixes() fixar bara specifika problem:
- Lockfiles (pnpm-lock.yaml, yarn.lock)
- Broken @utility blocks i CSS
- Instrument_Serif font weights
- "use client" directives

Men det finns många andra problem som kan uppstå i V0-genererad kod som
INTE fixas:
- Saknade npm-paket i package.json
- Felaktiga import-sökvägar
- Saknade dependencies för shadcn/ui
- Felaktiga TypeScript-typer
- Saknade CSS-variabler eller Tailwind-konfiguration

PLATS:
- src/app/api/v0/deployments/route.ts:29-187

FÖRVÄNTAT BETEENDE:
Pre-deploy fixes ska identifiera och fixa vanliga problem i V0-genererad kod
för att säkerställa att deployment fungerar.

FAKTISKT BETEENDE:
Endast ett fåtal specifika problem fixas. Många andra problem kan leda till
deployment-fel som måste fixas manuellt.

SANNOLIKHET ATT DET ÄR EN BUGG: 70%
PÅVERKAN: Medel
PRIORITET: Medel

KOD-REFERENS:
```typescript
// src/app/api/v0/deployments/route.ts:29-187
function applyPreDeployFixes(files: Array<{ name: string; content: string }>): PreDeployDiagnostics {
  // Fixar bara:
  // 1. Lockfiles
  // 2. Broken @utility blocks
  // 3. Instrument_Serif weights
  // 4. "use client" directives
  // Saknar: npm dependencies, imports, TypeScript, Tailwind config, etc.
}
```

FÖRSLAGEN FIX:
Utöka applyPreDeployFixes med:
1. Verifiering av package.json dependencies mot imports i kod
2. Fix av felaktiga import-sökvägar (@/components -> relativa sökvägar)
3. Automatisk tillägg av saknade shadcn-dependencies
4. Verifiering av Tailwind-konfiguration
5. TypeScript-felhantering

═══════════════════════════════════════════════════════════════════════════
BUGG #5: Follow-up prompts kan skapa ny chat istället för att fortsätta
═══════════════════════════════════════════════════════════════════════════

BESKRIVNING:
Om chatId saknas när användaren försöker skicka en follow-up prompt, så
skapas en ny chat istället. Detta kan vara oönskat beteende om chatId
försvunnit av misstag (t.ex. localStorage rensad) men användaren vill
fortsätta samma konversation.

PLATS:
- src/lib/hooks/useV0ChatMessaging.ts:956-963

FÖRVÄNTAT BETEENDE:
Om chatId saknas men användaren försöker skicka en follow-up prompt, ska
systemet försöka återställa chatId från localStorage eller varna användaren.

FAKTISKT BETEENDE:
En ny chat skapas automatiskt utan varning.

SANNOLIKHET ATT DET ÄR EN BUGG: 60%
PÅVERKAN: Låg
PRIORITET: Låg

KOD-REFERENS:
```typescript
// src/lib/hooks/useV0ChatMessaging.ts:956-963
const sendMessage = useCallback(
  async (messageText: string, options: MessageOptions = {}) => {
    if (!messageText?.trim()) return;

    if (!chatId) {
      await createNewChat(messageText, options);  // <-- Skapar ny chat utan varning
      return;
    }
    // ...
  }
);
```

FÖRSLAGEN FIX:
Lägg till varning eller återställning:
```typescript
if (!chatId) {
  // Försök återställa från localStorage
  const lastChatId = localStorage.getItem("sajtmaskin:lastChatId");
  if (lastChatId) {
    setChatId(lastChatId);
    router.replace(`/builder?chatId=${encodeURIComponent(lastChatId)}`);
    // Fortsätt med samma chatId
  } else {
    // Varna användaren innan ny chat skapas
    const confirmed = confirm("Ingen aktiv chat hittades. Skapa ny chat?");
    if (!confirmed) return;
    await createNewChat(messageText, options);
  }
  return;
}
```

═══════════════════════════════════════════════════════════════════════════
BUGG #6: Model tier-val krävs innan första prompt kan skickas
═══════════════════════════════════════════════════════════════════════════

BESKRIVNING:
Om användaren kommer till /builder med en prompt men inte har valt model tier,
så öppnas en modal för model-val. Men om användaren stänger modalen utan
att välja, så kan prompten inte skickas.

PLATS:
- src/app/builder/page.tsx:654-666

FÖRVÄNTAT BETEENDE:
Om användaren kommer med en prompt, ska model tier väljas automatiskt eller
så ska prompten kunna skickas med default model tier.

FAKTISKT BETEENDE:
Användaren måste manuellt välja model tier innan prompten kan skickas.

SANNOLIKHET ATT DET ÄR EN BUGG: 50%
PÅVERKAN: Medel
PRIORITET: Medel

KOD-REFERENS:
```typescript
// src/app/builder/page.tsx:654-666
const requestCreateChat = useCallback(
  async (message: string, options?: CreateChatOptions) => {
    if (!chatId && !hasSelectedModelTier) {
      setPendingCreate({ message, options });
      setIsModelSelectOpen(true);
      return false;  // <-- Blockerar skapning tills model valts
    }
    // ...
  }
);
```

FÖRSLAGEN FIX:
Använd default model tier om ingen valts:
```typescript
const requestCreateChat = useCallback(
  async (message: string, options?: CreateChatOptions) => {
    if (!chatId && !hasSelectedModelTier) {
      // Använd default model tier istället för att blockera
      setHasSelectedModelTier(true);
      captureInstructionSnapshot();
      await createNewChat(message, options);
      return true;
    }
    // ...
  }
);
```

═══════════════════════════════════════════════════════════════════════════
BUGG #7: Saknad felhantering vid V0 API-fel i stream
═══════════════════════════════════════════════════════════════════════════

BESKRIVNING:
Om V0 API returnerar ett fel i streamen, så hanteras det inte alltid korrekt.
Vissa fel kan leda till att chatId inte sparas eller att användaren inte
får feedback om vad som gick fel.

PLATS:
- src/app/api/v0/chats/stream/route.ts:116-445
- src/lib/hooks/useV0ChatMessaging.ts:741-936

FÖRVÄNTAT BETEENDE:
Alla V0 API-fel ska hanteras och användaren ska få tydlig feedback.

FAKTISKT BETEENDE:
Vissa fel kan missas eller hanteras felaktigt, vilket kan leda till att
chatId inte sparas eller att användaren ser generiska felmeddelanden.

SANNOLIKHET ATT DET ÄR EN BUGG: 65%
PÅVERKAN: Medel
PRIORITET: Medel

KOD-REFERENS:
```typescript
// src/lib/hooks/useV0ChatMessaging.ts:868-872
case "error": {
  const errorData =
    typeof data === "object" && data ? (data as any) : { message: data };
  throw new Error(errorData.message || errorData.error || "Stream error");
}
// Kan missa vissa fel-typer eller ge otydliga meddelanden
```

FÖRSLAGEN FIX:
Förbättra felhantering med mer specifika felmeddelanden och logging.

═══════════════════════════════════════════════════════════════════════════
BUGG #8: CSS-validering körs i bakgrunden utan garanti för completion
═══════════════════════════════════════════════════════════════════════════

BESKRIVNING:
CSS-validering körs i bakgrunden efter generation completion, men det finns
ingen garanti att den faktiskt körs eller slutförs. Om valideringen misslyckas,
så loggas bara ett varning utan att användaren informeras.

PLATS:
- src/app/builder/page.tsx:612-617

FÖRVÄNTAT BETEENDE:
CSS-validering ska köras och användaren ska informeras om problem hittas.

FAKTISKT BETEENDE:
Validering körs i bakgrunden och misslyckanden loggas bara till console.

SANNOLIKHET ATT DET ÄR EN BUGG: 55%
PÅVERKAN: Låg
PRIORITET: Låg

KOD-REFERENS:
```typescript
// src/app/builder/page.tsx:612-617
if (data.chatId && data.versionId) {
  // Run CSS validation in background (don't block UI)
  validateCss(data.chatId, data.versionId).catch((err) => {
    console.warn("[CSS Validation] Failed:", err);  // <-- Bara console.warn
  });
}
```

FÖRSLAGEN FIX:
Lägg till toast-notifikation om validering hittar problem eller misslyckas.

═══════════════════════════════════════════════════════════════════════════
SAMMANFATTNING
═══════════════════════════════════════════════════════════════════════════

Totalt antal buggar identifierade: 8

KRITISKA/HÖGA PRIORITET (3):
1. Bug #1: Initial prompt skickas inte automatiskt (95% sannolikhet, Hög påverkan)
2. Bug #3: V0 saknar garanti för Shadcn-installation (85% sannolikhet, Hög påverkan)
3. Bug #4: Pre-deploy fixes är begränsade (70% sannolikhet, Medel påverkan)

MEDEL PRIORITET (3):
4. Bug #2: promptId misslyckas tyst (90% sannolikhet, Medel påverkan)
5. Bug #6: Model tier-val krävs (50% sannolikhet, Medel påverkan)
6. Bug #7: Saknad felhantering vid V0 API-fel (65% sannolikhet, Medel påverkan)

LÅG PRIORITET (2):
7. Bug #5: Follow-up prompts kan skapa ny chat (60% sannolikhet, Låg påverkan)
8. Bug #8: CSS-validering körs i bakgrunden (55% sannolikhet, Låg påverkan)

═══════════════════════════════════════════════════════════════════════════
REKOMMENDATIONER
═══════════════════════════════════════════════════════════════════════════

1. PRIORITERA Bug #1 - Detta påverkar alla användare som kommer till sajten
   med en prompt och förväntar sig automatisk generering.

2. PRIORITERA Bug #3 - Shadcn-installation är kritisk för att genererad kod
   ska fungera korrekt vid deployment.

3. UTÖKA Bug #4 - Pre-deploy fixes bör utökas för att hantera fler vanliga
   problem i V0-genererad kod.

4. FÖRBÄTTRA Bug #2 - Användarfeedback är viktigt när saker går fel.

5. ÖVERVÄGA Bug #6 - Automatisk model tier-val kan förbättra UX.

═══════════════════════════════════════════════════════════════════════════
SLUT
═══════════════════════════════════════════════════════════════════════════
