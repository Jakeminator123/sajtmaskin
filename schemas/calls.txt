SAJTMASKIN SCHEMAS - CALLS
Goal: Standardiserad oversikt av viktigaste anrop och var de hanteras.

STANDARD FORMAT (per entry)
ENDPOINT:
TRIGGER (UI):
REQUEST BODY (keys):
RESPONSE (keys):
RELATED FILES:
NOTES:

==============================================================================
FLOWS (builder)
==============================================================================
FLOW: BUILDER_CREATE_CHAT
ENDPOINT: /api/v0/chats/stream (POST, SSE)
TRIGGER (UI): forsta skick i buildern (ingen chatId)
REQUEST BODY: message, modelId, thinking, imageGenerations, system?, attachments?
RESPONSE: SSE events (chatId, thinking, content, parts, done)
RELATED FILES:
- src/lib/hooks/useV0ChatMessaging.ts
- src/app/api/v0/chats/stream/route.ts
NOTES:
- responseMode: experimental_stream
- chatId skickas via SSE event "chatId"
- system = Custom Instructions (gäller initial chat creation)

FLOW: BUILDER_SEND_MESSAGE
ENDPOINT: /api/v0/chats/{chatId}/stream (POST, SSE)
TRIGGER (UI): skick i buildern (har chatId)
REQUEST BODY: message, attachments?
RESPONSE: SSE events (thinking, content, parts, done)
RELATED FILES:
- src/lib/hooks/useV0ChatMessaging.ts
- src/app/api/v0/chats/[chatId]/stream/route.ts

FLOW: BUILDER_TEMPLATE_INIT
ENDPOINT: /api/template (POST)
TRIGGER (UI): /builder?templateId=...
REQUEST BODY: templateId, quality?, skipCache?
RESPONSE: success, chatId, demoUrl, files, code
RELATED FILES:
- src/app/builder/page.tsx
- src/app/api/template/route.ts
- src/lib/v0/v0-generator.ts
NOTES:
- Per-user cache i template_cache

FLOW: BUILDER_IMPORT
ENDPOINT: /api/v0/chats/init (POST)
TRIGGER (UI): Import modal (GitHub/ZIP)
REQUEST BODY:
- source: { type: "github", url, branch?, preferZip? }
- source: { type: "zip", content } | { type: "zip", url }
- message?, projectId?, lockConfigFiles?, lockedFiles?
RESPONSE: id (v0 chatId), internalChatId, lockedFiles, source
RELATED FILES:
- src/components/builder/InitFromRepoModal.tsx
- src/app/api/v0/chats/init/route.ts

FLOW: BUILDER_BLOCKS
ENDPOINT: /api/v0/chats/init-registry (POST)
TRIGGER (UI): Blocks modal (shadcn registry)
REQUEST BODY: registryUrl, quality?, name?, projectId?
RESPONSE: chatId, internalChatId, demoUrl, versionId
RELATED FILES:
- src/components/builder/InitFromRepoModal.tsx
- src/app/api/v0/chats/init-registry/route.ts
- src/lib/v0/v0-generator.ts

FLOW: INTEGRATIONS_STATUS
ENDPOINT: /api/integrations/status (GET)
TRIGGER (UI): Builder IntegrationStatusPanel
RESPONSE: items[] (enabled, required, affects, requiredEnv)
RELATED FILES:
- src/components/builder/IntegrationStatusPanel.tsx
- src/app/api/integrations/status/route.ts

==============================================================================
PROMPT ASSIST (gateway / direct)
==============================================================================
FLOW: PROMPT_ASSIST_SIMPLE
ENDPOINT: /api/ai/chat (POST)
TRIGGER (UI): Prompt Assist ON + deep=false
REQUEST BODY: provider, model, temperature, messages[]
RESPONSE: text (rewritten prompt)
EXAMPLE (gateway):
{ provider: "gateway", model: "openai/gpt-5.2", temperature: 0.2, messages: [{ role: "system", content: "..." }, { role: "user", content: "..." }] }
EXAMPLE (openai):
{ provider: "openai", model: "gpt-4o-mini", temperature: 0.2, messages: [{ role: "system", content: "..." }, { role: "user", content: "..." }] }
RELATED FILES:
- src/lib/hooks/usePromptAssist.ts
- src/app/api/ai/chat/route.ts
- src/lib/builder/promptAssist.ts

FLOW: PROMPT_ASSIST_DEEP
ENDPOINT: /api/ai/brief (POST)
TRIGGER (UI): Prompt Assist ON + deep=true
REQUEST BODY: provider, model, temperature, prompt, imageGenerations
RESPONSE: JSON brief
EXAMPLE (gateway):
{ provider: "gateway", model: "openai/gpt-5.2", temperature: 0.2, prompt: "...", imageGenerations: true }
EXAMPLE (anthropic):
{ provider: "anthropic", model: "claude-sonnet-4.5", temperature: 0.2, prompt: "...", imageGenerations: true }
RELATED FILES:
- src/lib/hooks/usePromptAssist.ts
- src/app/api/ai/brief/route.ts
- src/lib/builder/promptAssist.ts

==============================================================================
VERSIONS / FILES
==============================================================================
FLOW: VERSION_LIST
ENDPOINT: /api/v0/chats/{chatId}/versions (GET)
TRIGGER (UI): VersionHistory
RESPONSE: versions[]
RELATED FILES:
- src/components/builder/VersionHistory.tsx
- src/app/api/v0/chats/[chatId]/versions/route.ts

FLOW: VERSION_PIN
ENDPOINT: /api/v0/chats/{chatId}/versions (PATCH)
TRIGGER (UI): Pin/unpin
REQUEST BODY: versionId, pinned
RESPONSE: success, pinned, pinnedAt
NOTES: pinned version ar read-only

FLOW: FILES
ENDPOINT: /api/v0/chats/{chatId}/files (GET/PUT/PATCH/DELETE)
TRIGGER (UI): filhantering i builder
NOTES: blockerar write om version ar pinned
RELATED FILES:
- src/app/api/v0/chats/[chatId]/files/route.ts

FLOW: VERSION_NORMALIZE_TEXT
ENDPOINT: /api/v0/chats/{chatId}/normalize-text (POST)
TRIGGER (UI): Builder -> onGenerationComplete (auto-fix)
REQUEST BODY: versionId, autoFix?
RESPONSE: normalized, changed, changedFiles, replacements, fixed?, demoUrl?
RELATED FILES:
- src/app/api/v0/chats/[chatId]/normalize-text/route.ts
- src/app/builder/page.tsx
- src/lib/utils/unicode-normalizer.ts
NOTES: Avkodar \uXXXX-sekvenser till riktiga tecken i text.

==============================================================================
DEPLOY / VERCEL
==============================================================================
FLOW: DEPLOY_CREATE
ENDPOINT: /api/v0/deployments (POST)
TRIGGER (UI): Builder -> Deploy (production/preview)
REQUEST BODY: chatId, versionId, target?, imageStrategy?, projectName?, projectId?
RESPONSE: id, status, url?, inspectorUrl?, vercelDeploymentId?, vercelProjectId?, readyState?, fixesApplied?, imageAssetsSummary?, imageAssetsWarnings?
RELATED FILES:
- src/app/builder/page.tsx
- src/app/api/v0/deployments/route.ts
- src/lib/vercelDeploy.ts
- src/lib/imageAssets.ts
NOTES:
- materialiserar bilder om imageStrategy=blob (kraver BLOB_READ_WRITE_TOKEN)

FLOW: DEPLOY_LIST
ENDPOINT: /api/v0/deployments?chatId=... (GET)
TRIGGER (UI): Builder (deploy-historik / status)
RESPONSE: deployments[]
RELATED FILES:
- src/app/api/v0/deployments/route.ts

FLOW: DEPLOY_STATUS
ENDPOINT: /api/v0/deployments/{deploymentId} (GET)
TRIGGER (UI): status polling (om behov)
RESPONSE: id, status, url?, inspectorUrl?, readyState?
RELATED FILES:
- src/app/api/v0/deployments/[deploymentId]/route.ts

FLOW: VERCEL_PURCHASE_AND_DEPLOY
ENDPOINT: /api/vercel/purchase-and-deploy (POST)
TRIGGER (UI): Finalize modal -> "Kop & deploya"
REQUEST BODY: projectId, domain, years?, contactInfo{...}, projectName?, framework?, teamId?
RESPONSE: success, domain, deploymentId, deploymentUrl, customDomainUrl, orderId, customerPrice, vercelCost, currency, domainAdded, warning?
RELATED FILES:
- src/components/modals/finalize-modal.tsx
- src/app/api/vercel/purchase-and-deploy/route.ts

FLOW: VERCEL_DEPLOY_STATUS
ENDPOINT: /api/vercel/status/{deploymentId} (GET)
TRIGGER (UI): status for project deploys
RESPONSE: success, deployment
RELATED FILES:
- src/app/api/vercel/status/[deploymentId]/route.ts

==============================================================================
EXPORT / DOWNLOAD
==============================================================================
FLOW: VERSION_DOWNLOAD
ENDPOINT: /api/v0/chats/{chatId}/versions/{versionId}/download (GET)
TRIGGER (UI): ladda ner version (zip/tar)
REQUEST BODY: format?=zip|tar, includeDefaultFiles?
RESPONSE: file stream eller redirect URL
RELATED FILES:
- src/app/api/v0/chats/[chatId]/versions/[versionId]/download/route.ts

FLOW: VERSION_EXPORT_BLOB
ENDPOINT: /api/v0/chats/{chatId}/versions/{versionId}/export (POST)
TRIGGER (UI): export/share (blob url)
REQUEST BODY: format?=zip|tar, includeDefaultFiles?
RESPONSE: ok, format, contentType, size, blob
RELATED FILES:
- src/app/api/v0/chats/[chatId]/versions/[versionId]/export/route.ts

FLOW: GITHUB_EXPORT
ENDPOINT: /api/github/export (POST)
TRIGGER (UI): export till GitHub
REQUEST BODY: chatId, versionId, repo, private?
RESPONSE: success, repo, repoUrl, created, commitSha
RELATED FILES:
- src/app/api/github/export/route.ts

FLOW: PROJECT_DOWNLOAD
ENDPOINT: /api/projects/{id}/download (GET)
TRIGGER (UI): ladda ner fran Projects
RESPONSE: zip file
RELATED FILES:
- src/app/api/projects/[id]/download/route.ts

==============================================================================
MEDIA / UPLOADS
==============================================================================
FLOW: MEDIA_UPLOAD
ENDPOINT: /api/media/upload (POST)
TRIGGER (UI): media drawer / file upload
REQUEST BODY: multipart form-data (file, projectId?, description?, tags?)
RESPONSE: success, media{ id, url, filename, mimeType, fileType, size, storageType }, note?
RELATED FILES:
- src/components/media/file-upload-zone.tsx
- src/components/media/media-drawer.tsx
- src/app/api/media/upload/route.ts

FLOW: MEDIA_LIBRARY_LIST
ENDPOINT: /api/media/upload (GET)
TRIGGER (UI): media drawer open / filter
REQUEST BODY: fileType? (query)
RESPONSE: success, items[], counts, limits
RELATED FILES:
- src/app/api/media/upload/route.ts

FLOW: MEDIA_UPLOAD_FROM_URL
ENDPOINT: /api/media/upload-from-url (POST)
TRIGGER (UI): stock images / URL import
REQUEST BODY: url, filename?, source?, photographer?
RESPONSE: success, media{ url, filename, contentType, size, source, photographer, storageType }
RELATED FILES:
- src/app/api/media/upload-from-url/route.ts

FLOW: MEDIA_DELETE
ENDPOINT: /api/media/{id} (DELETE)
TRIGGER (UI): radera mediafil
RESPONSE: success
RELATED FILES:
- src/app/api/media/[id]/route.ts

FLOW: MEDIA_SERVE_LOCAL
ENDPOINT: /api/uploads/media/{userId}/{filename} (GET)
TRIGGER (UI): local fallback nar Blob saknas
RESPONSE: file bytes
RELATED FILES:
- src/app/api/uploads/media/[...path]/route.ts

FLOW: UPLOADS_SERVE
ENDPOINT: /api/uploads/{filename} (GET)
TRIGGER (UI): local uploads
RESPONSE: file bytes
RELATED FILES:
- src/app/api/uploads/[filename]/route.ts

FLOW: UNSPLASH_SEARCH
ENDPOINT: /api/unsplash (GET/POST)
TRIGGER (UI): stock image search
REQUEST BODY: industry?, customTerms?, count? (POST) | query?, count? (GET)
RESPONSE: success, images[]
RELATED FILES:
- src/app/api/unsplash/route.ts

FLOW: UNSPLASH_TRACK_DOWNLOAD
ENDPOINT: /api/unsplash/download (POST)
TRIGGER (UI): nar foto anvands
REQUEST BODY: downloadLocation? eller photoId?
RESPONSE: success, tracked, url?
RELATED FILES:
- src/app/api/unsplash/download/route.ts

FLOW: FIGMA_PREVIEW
ENDPOINT: /api/figma/preview (POST)
TRIGGER (UI): figma länk i buildern
REQUEST BODY: url
RESPONSE: imageUrl, fileName?
RELATED FILES:
- src/components/builder/ChatInterface.tsx
- src/app/api/figma/preview/route.ts

ENV / CONFIG (relevant to calls)
==============================================================================
MODEL TIERS:
- v0-mini, v0-pro, v0-max (builder)

PROVIDERS (prompt assist):
- gateway (AI Gateway)
- openai (Direct OpenAI)
- anthropic (Direct Anthropic)
- off (ingen omskrivning)

ENV FLAGS:
- AI_GATEWAY_API_KEY or VERCEL_OIDC_TOKEN (for provider=gateway)
- OPENAI_API_KEY (for provider=openai)
- ANTHROPIC_API_KEY or CLAUDE_ANTHROPIC_API_KEY (for provider=anthropic)
- V0_API_KEY (v0 generation)
- DEBUG=AI or DEBUG=true (server debug logs)
- V0_STREAM_DEBUG=1 (logga SSE events i /api/v0/chats/stream)

RELATED FILES:
- src/lib/builder/defaults.ts
- src/lib/hooks/usePromptAssist.ts
- src/app/api/ai/chat/route.ts
- src/app/api/ai/brief/route.ts
- src/app/api/v0/chats/stream/route.ts
