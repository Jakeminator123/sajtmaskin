BUGGRAPPORT - INSTALLATION & V0-INTEGRATION
===========================================
Genererad: 2026-02-01
Analys av: Installation och första prompt-flöde till V0 API

ÖVERSIKT
--------
Denna rapport analyserar buggar relaterade till installationen när användare besöker sajten för att bygga en ny hemsida. Fokus ligger på:
1. Hur första prompten skickas till V0 API
2. Om Shadcn/ui är korrekt installerat och konfigurerat
3. Om V0-agenten har begränsningar i funktionalitet

STRUKTURELLT FLÖDE
------------------
1. Användare kommer till sajten via:
   - Home page → `/builder?prompt=...` eller `/builder?promptId=...`
   - Audit → `/builder?source=audit&auditId=...`
   - Template → `/builder?templateId=...`
   - Shadcn registry → `/builder` (via `handleStartFromRegistry`)

2. Builder-sidan (`src/app/builder/page.tsx`):
   - Läser prompt från URL-parametrar eller localStorage
   - Om ingen chatId finns och prompt finns → skapar ny chat
   - Anropar `createNewChat()` från `useV0ChatMessaging`

3. Prompt-förbättring (`useV0ChatMessaging.createNewChat`):
   - Om `skipPromptAssist` är false → anropar `maybeEnhanceInitialPrompt()`
   - Prompt Assist kan vara: "off", "gateway", eller "openai-compat"
   - Standard är "gateway" med "deep: true" (Creative Brief Enhancer)

4. Skicka till V0 (`/api/v0/chats/stream`):
   - Validerar prompt med `createChatSchema`
   - Anropar `v0.chats.create()` med:
     * message: (förbättrad) prompt
     * system: customInstructions (standard: "Use Next.js App Router, Tailwind CSS, and shadcn/ui")
     * modelId: v0-mini/v0-pro/v0-max
     * thinking: true för v0-max
     * imageGenerations: true (standard)

BUGG #1: SHADCN/UI INTE INKLUDERAT I PACKAGE.JSON VID DEPLOYMENT
==================================================================
Sannolikhet att det är en bugg: 95%
Påverkan: HÖG

BESKRIVNING:
När kod deployas till Vercel via `vercel-deployment-service.ts` skapas en `package.json` som INTE innehåller shadcn/ui-paket eller dess dependencies (@radix-ui/*).

FIL: `src/lib/vercel/vercel-deployment-service.ts` (rad 48-76)

PROBLEM:
```typescript
const PACKAGE_JSON = `{
  "dependencies": {
    "next": "15.0.0",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "lucide-react": "^0.468.0",
    "clsx": "^2.1.1",
    "tailwind-merge": "^2.6.0",
    "class-variance-authority": "^0.7.1",
    "framer-motion": "^11.15.0"
  },
  ...
}`;
```

Saknas:
- @radix-ui/* paket (t.ex. @radix-ui/react-dialog, @radix-ui/react-dropdown-menu, etc.)
- Andra shadcn/ui dependencies som kan behövas

KONSEKVENSER:
- Genererad kod som använder shadcn/ui-komponenter kommer att faila vid build/deploy
- Runtime-fel när komponenter försöker importeras
- Användare får broken deployments

LÖSNING:
Lägg till shadcn/ui dependencies i PACKAGE_JSON. Antingen:
1. Lägg till alla vanliga @radix-ui-paket som shadcn använder
2. Eller analysera genererad kod för att identifiera vilka paket som behövs
3. Eller lägg till en komplett lista av shadcn/ui dependencies

REKOMMENDATION:
Skapa en funktion som analyserar genererad kod och lägger till saknade dependencies automatiskt, eller inkludera en komplett baseline av shadcn/ui-paket.

BUGG #2: SHADCN/UI INTE EXPLICIT INSTALLERAT I SYSTEMPROMPT
============================================================
Sannolikhet att det är en bugg: 70%
Påverkan: MEDEL

BESKRIVNING:
Systemprompten säger "Use shadcn/ui" men instruerar INTE V0 att säkerställa att shadcn/ui är installerat och konfigurerat.

FIL: `src/lib/builder/defaults.ts` (rad 143-146)
```typescript
export const DEFAULT_CUSTOM_INSTRUCTIONS =
  "Use Next.js App Router, Tailwind CSS, and shadcn/ui.\n" +
  "Build a responsive, accessible, polished React UI with high visual quality.\n" +
  "If imagery is used, ensure high-quality visuals and descriptive alt text.";
```

OCH: `src/lib/builder/promptAssist.ts` (rad 116)
```typescript
"Use shadcn/ui components where appropriate (buttons, inputs, cards, dialogs).",
```

PROBLEM:
- Instruktionen säger "use" men inte "install and configure"
- V0 kan generera kod som använder shadcn-komponenter utan att säkerställa installation
- Ingen instruktion om att lägga till shadcn/ui i package.json
- Ingen instruktion om att konfigurera components.json eller utils

KONSEKVENSER:
- V0 kan generera kod som förväntar sig shadcn/ui utan att installera det
- Komponenter kan saknas vid runtime
- Användare måste manuellt installera shadcn/ui efter generation

LÖSNING:
Uppdatera systemprompten till:
```
"Use Next.js App Router, Tailwind CSS, and shadcn/ui.
Ensure shadcn/ui is properly installed (add @radix-ui dependencies to package.json)
and configured (components.json, lib/utils.ts with cn helper).
Use shadcn/ui components where appropriate (buttons, inputs, cards, dialogs)."
```

BUGG #3: INGEN VALIDERING AV SHADCN/UI INSTALLATION INNAN KODGENERERING
========================================================================
Sannolikhet att det är en bugg: 60%
Påverkan: MEDEL

BESKRIVNING:
Det finns ingen validering eller säkerställande att shadcn/ui är installerat innan kod genereras. V0 kan generera kod som förväntar sig shadcn/ui utan att det finns.

FILER:
- `src/app/api/v0/chats/stream/route.ts` - Skapar ny chat
- `src/lib/v0/v0-generator.ts` - Genererar kod

PROBLEM:
- Ingen pre-flight check att shadcn/ui är installerat
- Ingen post-generation validering att genererad kod kan köras
- V0 kan generera kod med shadcn-imports utan att paketen finns

KONSEKVENSER:
- Broken code vid första generation
- Användare måste manuellt fixa imports/dependencies
- Sämre användarupplevelse

LÖSNING:
1. Lägg till validering i systemprompten (se bugg #2)
2. Eller lägg till post-generation validering som kontrollerar imports
3. Eller lägg till automatisk dependency-injection baserat på genererad kod

BUGG #4: SHADCN REGISTRY INITIERING ANVÄNDER ANNAN ROUTE
=========================================================
Sannolikhet att det är en bugg: 30%
Påverkan: LÅG

BESKRIVNING:
När användare startar från shadcn/ui registry används `/api/v0/chats/init-registry` istället för standard `/api/v0/chats/stream`. Detta kan leda till inkonsekvent beteende.

FIL: `src/app/builder/page.tsx` (rad 668-719)
```typescript
const handleStartFromRegistry = useCallback(
  async (selection: ShadcnBlockSelection) => {
    const response = await fetch("/api/v0/chats/init-registry", {
      method: "POST",
      body: JSON.stringify({
        registryUrl: selection.registryUrl,
        quality,
        name,
      }),
    });
  }
);
```

PROBLEM:
- Olika routes kan ha olika beteenden
- Systemprompten kanske inte appliceras på samma sätt
- Custom instructions kanske inte används

KONSEKVENSER:
- Inkonsekvent beteende mellan olika initieringsmetoder
- Potentiellt att systemprompten med shadcn-instruktioner hoppas över

LÖSNING:
Kontrollera att `/api/v0/chats/init-registry` använder samma systemprompt och validering som `/api/v0/chats/stream`.

BUGG #5: PROMPT ASSIST KAN HOPPA ÖVER SHADCN-INSTRUKTIONER
==========================================================
Sannolikhet att det är en bugg: 40%
Påverkan: MEDEL

BESKRIVNING:
När Prompt Assist förbättrar prompten kan den potentiellt ta bort eller ändra shadcn/ui-instruktioner.

FIL: `src/lib/hooks/usePromptAssist.ts`
- `buildV0RewriteSystemPrompt()` säger bara "rewrite the user request" utan att nämna shadcn
- `buildV0PromptFromBrief()` inkluderar shadcn men bara när "deep" mode används

PROBLEM:
- Prompt Assist kan skriva om prompten utan att behålla shadcn-instruktioner
- Om användaren har "off" eller "openai-compat" kan shadcn-instruktioner saknas
- Systemprompten appliceras separat, men Prompt Assist kan ändra huvudprompten

KONSEKVENSER:
- V0 kan generera kod utan shadcn/ui om Prompt Assist tar bort instruktionerna
- Inkonsekvent beteende beroende på Prompt Assist-inställningar

LÖSNING:
1. Säkerställ att systemprompten alltid inkluderar shadcn-instruktioner (görs redan)
2. Uppdatera `buildV0RewriteSystemPrompt()` att alltid inkludera shadcn-instruktioner
3. Eller validera att genererad prompt innehåller shadcn-referenser

BUGG #6: INGEN POST-GENERATION VALIDERING AV DEPENDENCIES
==========================================================
Sannolikhet att det är en bugg: 80%
Påverkan: HÖG

BESKRIVNING:
Efter att kod genererats finns det ingen validering att alla imports och dependencies finns. CSS valideras (via `useCssValidation`) men inte JavaScript/TypeScript imports.

FIL: `src/app/builder/page.tsx` (rad 612-617)
```typescript
if (data.chatId && data.versionId) {
  validateCss(data.chatId, data.versionId).catch((err) => {
    console.warn("[CSS Validation] Failed:", err);
  });
}
```

PROBLEM:
- CSS valideras men inte imports/dependencies
- Genererad kod kan ha imports till paket som inte finns
- Ingen automatisk fix av saknade dependencies

KONSEKVENSER:
- Broken code vid runtime
- Användare måste manuellt fixa imports
- Deployment kan faila

LÖSNING:
Lägg till dependency-validering som:
1. Analyserar genererad kod för imports
2. Identifierar saknade paket
3. Lägger till dem automatiskt i package.json (vid deployment) eller varnar användaren

BUGG #7: TEMPLATE INITIERING ANVÄNDER ANNAN ROUTE
==================================================
Sannolikhet att det är en bugg: 25%
Påverkan: LÅG

BESKRIVNING:
När användare startar från template används `/api/template` istället för standard route. Detta kan leda till att systemprompten inte appliceras.

FIL: `src/app/builder/page.tsx` (rad 793-820)
```typescript
const initTemplate = async () => {
  const response = await fetch("/api/template", {
    method: "POST",
    body: JSON.stringify({ templateId, quality }),
  });
};
```

PROBLEM:
- Olika route kan ha olika beteenden
- Systemprompten kanske inte appliceras
- Custom instructions kanske inte används

KONSEKVENSER:
- Inkonsekvent beteende
- Shadcn-instruktioner kanske inte appliceras vid template-initiering

LÖSNING:
Kontrollera att `/api/template` använder samma systemprompt och validering.

BUGG #8: INGEN EXPLICIT INSTRUKTION OM COMPONENTS.JSON
=======================================================
Sannolikhet att det är en bugg: 50%
Påverkan: MEDEL

BESKRIVNING:
Systemprompten nämner shadcn/ui men instruerar inte V0 att skapa eller konfigurera `components.json` som krävs för shadcn/ui.

PROBLEM:
- shadcn/ui kräver `components.json` för konfiguration
- V0 kan generera komponenter utan att konfigurera shadcn korrekt
- Import-paths kan vara fel utan korrekt konfiguration

KONSEKVENSER:
- Komponenter kanske inte fungerar korrekt
- Import-fel
- Inkonsekvent struktur

LÖSNING:
Lägg till instruktion i systemprompten:
```
"Ensure components.json is configured with correct paths (@/components/ui, etc.)
and that lib/utils.ts contains the cn() helper function for className merging."
```

SAMMANFATTNING
===============
Totalt antal buggar identifierade: 8

KRITISKA (Hög påverkan, Hög sannolikhet):
- Bug #1: Shadcn/ui inte i package.json vid deployment (95% sannolikhet, HÖG påverkan)
- Bug #6: Ingen post-generation validering av dependencies (80% sannolikhet, HÖG påverkan)

VIKTIGA (Medel-Hög påverkan):
- Bug #2: Shadcn/ui inte explicit installerat i systemprompt (70% sannolikhet, MEDEL påverkan)
- Bug #3: Ingen validering av shadcn installation (60% sannolikhet, MEDEL påverkan)
- Bug #5: Prompt Assist kan hoppa över shadcn-instruktioner (40% sannolikhet, MEDEL påverkan)
- Bug #8: Ingen explicit instruktion om components.json (50% sannolikhet, MEDEL påverkan)

MINDRE VIKTIGA (Låg påverkan):
- Bug #4: Shadcn registry använder annan route (30% sannolikhet, LÅG påverkan)
- Bug #7: Template initiering använder annan route (25% sannolikhet, LÅG påverkan)

REKOMMENDATIONER
=================
1. KRITISKT: Fixa Bug #1 - Lägg till shadcn/ui dependencies i PACKAGE_JSON
2. KRITISKT: Implementera Bug #6 - Lägg till dependency-validering efter generation
3. VIKTIGT: Uppdatera systemprompten (Bug #2, #8) för explicit shadcn-installation
4. VIKTIGT: Lägg till validering (Bug #3) att shadcn är installerat
5. MINDRE: Kontrollera konsistens mellan olika initieringsroutes (Bug #4, #7)

PRIORITERING
=============
1. Bug #1 - Deployment package.json (KRITISK)
2. Bug #6 - Dependency validering (KRITISK)
3. Bug #2 - Systemprompt uppdatering (VIKTIG)
4. Bug #8 - components.json instruktion (VIKTIG)
5. Bug #3 - Pre-flight validering (VIKTIG)
6. Bug #5 - Prompt Assist konsistens (MEDEL)
7. Bug #4, #7 - Route konsistens (LÅG)
